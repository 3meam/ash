<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASH Protocol Demo</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card h2 { margin-top: 0; color: #444; }
    input, button {
      padding: 10px 15px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    input { width: 200px; }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .danger { background: #dc3545; }
    .danger:hover { background: #c82333; }
    .success { background: #28a745; }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .success-msg { color: #28a745; font-weight: bold; }
    .error-msg { color: #dc3545; font-weight: bold; }
    .info { color: #666; font-size: 14px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>üîê ASH Protocol Demo</h1>

  <div class="card">
    <h2>1. Update Profile (Normal Request)</h2>
    <p class="info">This demonstrates a successful ASH-protected request.</p>
    <input type="text" id="name" placeholder="Name" value="John Doe">
    <input type="email" id="email" placeholder="Email" value="john@example.com">
    <button onclick="updateProfile()">Update Profile</button>
    <div id="profile-result"></div>
  </div>

  <div class="card">
    <h2>2. Tamper Detection Demo</h2>
    <p class="info">This shows what happens when someone tampers with the payload after signing.</p>
    <button class="danger" onclick="tamperDemo()">Try Tampered Request</button>
    <div id="tamper-result"></div>
  </div>

  <div class="card">
    <h2>3. Replay Detection Demo</h2>
    <p class="info">This shows what happens when someone tries to replay the same request.</p>
    <button class="danger" onclick="replayDemo()">Try Replay Attack</button>
    <div id="replay-result"></div>
  </div>

  <div class="card">
    <h2>Request Log</h2>
    <pre id="log">Waiting for requests...</pre>
  </div>

  <script type="module">
    // Simple SHA-256 implementation for browser
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return btoa(String.fromCharCode(...hashArray))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=/g, '');
    }

    // Canonicalize JSON (simplified - production should use full implementation)
    function canonicalizeJson(obj) {
      return JSON.stringify(obj, Object.keys(obj).sort());
    }

    // Build ASH proof
    async function buildProof(mode, binding, contextId, nonce, canonicalPayload) {
      let input = `ASHv1\n${mode}\n${binding}\n${contextId}\n`;
      if (nonce) input += `${nonce}\n`;
      input += canonicalPayload;
      return sha256(input);
    }

    // Log helper
    function log(message) {
      const logEl = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      logEl.textContent = `[${time}] ${message}\n\n` + logEl.textContent;
    }

    // Get context from server
    async function getContext(binding) {
      const res = await fetch('/ash/context', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: binding })
      });
      return res.json();
    }

    // Make ASH-protected request
    async function ashRequest(url, binding, payload) {
      // Step 1: Get context
      log(`Getting context for ${binding}...`);
      const ctx = await getContext(binding);
      log(`Context received: ${ctx.contextId.slice(0, 8)}...`);

      // Step 2: Canonicalize payload
      const canonical = canonicalizeJson(payload);
      log(`Canonical payload: ${canonical}`);

      // Step 3: Build proof
      const proof = await buildProof(
        ctx.mode,
        binding,
        ctx.contextId,
        ctx.nonce,
        canonical
      );
      log(`Proof generated: ${proof.slice(0, 20)}...`);

      // Step 4: Send request
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-ASH-Context-Id': ctx.contextId,
          'X-ASH-Proof': proof
        },
        body: JSON.stringify(payload)
      });

      return { response: res, context: ctx, proof };
    }

    // Demo 1: Normal request
    window.updateProfile = async function() {
      const resultEl = document.getElementById('profile-result');
      try {
        const payload = {
          name: document.getElementById('name').value,
          email: document.getElementById('email').value
        };

        const { response } = await ashRequest(
          '/api/profile/update',
          'POST /api/profile/update',
          payload
        );

        const data = await response.json();

        if (response.ok) {
          resultEl.innerHTML = `<p class="success-msg">‚úì ${data.message}</p>`;
          log('SUCCESS: Profile updated');
        } else {
          resultEl.innerHTML = `<p class="error-msg">‚úó ${data.error?.message || 'Failed'}</p>`;
          log(`ERROR: ${data.error?.code}`);
        }
      } catch (err) {
        resultEl.innerHTML = `<p class="error-msg">‚úó ${err.message}</p>`;
        log(`ERROR: ${err.message}`);
      }
    };

    // Demo 2: Tamper detection
    window.tamperDemo = async function() {
      const resultEl = document.getElementById('tamper-result');
      try {
        // Get context
        const ctx = await getContext('POST /api/profile/update');
        log('Tamper demo: Got context');

        // Sign original payload
        const original = { name: 'Alice', email: 'alice@example.com' };
        const canonical = canonicalizeJson(original);
        const proof = await buildProof(ctx.mode, 'POST /api/profile/update', ctx.contextId, ctx.nonce, canonical);
        log('Tamper demo: Signed original payload');

        // Send DIFFERENT payload with same proof (tampered!)
        const tampered = { name: 'HACKED', email: 'hacker@evil.com' };
        log('Tamper demo: Sending tampered payload...');

        const res = await fetch('/api/profile/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-ASH-Context-Id': ctx.contextId,
            'X-ASH-Proof': proof
          },
          body: JSON.stringify(tampered)
        });

        const data = await res.json();

        if (res.ok) {
          resultEl.innerHTML = `<p class="error-msg">‚ö† Tamper not detected (unexpected)</p>`;
        } else {
          resultEl.innerHTML = `<p class="success-msg">‚úì Tamper DETECTED: ${data.error?.code}</p>`;
          log(`Tamper demo: BLOCKED - ${data.error?.code}`);
        }
      } catch (err) {
        resultEl.innerHTML = `<p class="error-msg">‚úó ${err.message}</p>`;
      }
    };

    // Demo 3: Replay detection
    window.replayDemo = async function() {
      const resultEl = document.getElementById('replay-result');
      try {
        const payload = { name: 'Bob', email: 'bob@example.com' };

        // First request (should succeed)
        log('Replay demo: Making first request...');
        const { response: res1, context: ctx, proof } = await ashRequest(
          '/api/profile/update',
          'POST /api/profile/update',
          payload
        );

        if (!res1.ok) {
          const data = await res1.json();
          resultEl.innerHTML = `<p class="error-msg">‚úó First request failed: ${data.error?.code}</p>`;
          return;
        }

        log('Replay demo: First request succeeded');

        // Second request with SAME context/proof (replay!)
        log('Replay demo: Attempting replay...');
        const res2 = await fetch('/api/profile/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-ASH-Context-Id': ctx.contextId,
            'X-ASH-Proof': proof
          },
          body: JSON.stringify(payload)
        });

        const data2 = await res2.json();

        if (res2.ok) {
          resultEl.innerHTML = `<p class="error-msg">‚ö† Replay not detected (unexpected)</p>`;
        } else {
          resultEl.innerHTML = `<p class="success-msg">‚úì Replay DETECTED: ${data2.error?.code}</p>`;
          log(`Replay demo: BLOCKED - ${data2.error?.code}`);
        }
      } catch (err) {
        resultEl.innerHTML = `<p class="error-msg">‚úó ${err.message}</p>`;
      }
    };

    log('ASH Demo loaded. Try the buttons above!');
  </script>
</body>
</html>
