name: Security Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cd ash-core && cargo audit

  constant-time-check:
    name: Constant-Time Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for unsafe comparisons
        run: |
          # Fail if == is used for proof/secret comparison
          if grep -rn "proof.*==" ash-core/src/ | grep -v "constant_time" | grep -v "test" | grep -v "//"; then
            echo "ERROR: Found potential timing-unsafe comparison"
            exit 1
          fi
          echo "No unsafe comparisons found"

  fail-closed-check:
    name: Fail-Closed Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for fail-open patterns
        run: |
          # Check for dangerous patterns
          FAIL_OPEN_PATTERNS=(
            "skip_verification"
            "disable_check"
            "bypass"
            "unsafe_allow"
            "no_verify"
          )

          for pattern in "${FAIL_OPEN_PATTERNS[@]}"; do
            if grep -rni "$pattern" ash-core/src/; then
              echo "ERROR: Found potential fail-open pattern: $pattern"
              exit 1
            fi
          done
          echo "No fail-open patterns found"

  determinism-test:
    name: Determinism Tests
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Run determinism tests
        run: cd ash-core && cargo test determinism

  security-tests:
    name: Security Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Run security tests
        run: |
          cd ash-core
          cargo test security
          cargo test replay
          cargo test constant_time
          cargo test canonicalization

  error-message-audit:
    name: Error Message Safety
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for unsafe error patterns
        run: |
          # Check for patterns that might leak secrets
          UNSAFE_PATTERNS=(
            "expected.*got"
            "secret.*="
            "key.*:"
            "hash.*failed.*at"
          )

          for pattern in "${UNSAFE_PATTERNS[@]}"; do
            if grep -rniE "$pattern" ash-core/src/ | grep -i "error\|err\|panic"; then
              echo "WARNING: Potential secret leak in error message: $pattern"
            fi
          done
